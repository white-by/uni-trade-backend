<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sysu.mapper.OrderMapper">

    <!-- ResultMap 映射 Order 实体，包括地址对象 -->
    <resultMap id="orderResultMap" type="com.sysu.entity.Order">
        <id property="tradeID" column="tradeID"/>
        <result property="sellerID" column="sellerID"/>
        <result property="buyerID" column="buyerID"/>
        <result property="goodsID" column="goodsID"/>
        <result property="price" column="price"/>
        <result property="deliveryMethod" column="deliveryMethod"/>
        <result property="orderTime" column="orderTime"/>
        <result property="payTime" column="payTime"/>
        <result property="shippingTime" column="shippingTime"/>
        <result property="turnoverTime" column="turnoverTime"/>
        <result property="shippingCost" column="shippingCost"/>
        <result property="status" column="status"/>
        <result property="sellerName" column="sellerName"/>
        <result property="buyerName" column="buyerName"/>
        <result property="goodsName" column="goodsName"/>

        <!-- 发货地址 -->
        <association property="senderAddress" javaType="com.sysu.entity.Address">
            <result property="addrID" column="sender_addrID"/>
            <result property="userID" column="sender_userID"/>
            <result property="province" column="sender_province"/>
            <result property="city" column="sender_city"/>
            <result property="districts" column="sender_area"/>
            <result property="address" column="sender_detailArea"/>
            <result property="tel" column="sender_tel"/>
            <result property="receiver" column="sender_receiver"/>
            <result property="isDefault" column="sender_isDefault"/>
        </association>

        <!-- 收货地址 -->
        <association property="shippingAddress" javaType="com.sysu.entity.Address">
            <result property="addrID" column="shipping_addrID"/>
            <result property="userID" column="shipping_userID"/>
            <result property="province" column="shipping_province"/>
            <result property="city" column="shipping_city"/>
            <result property="districts" column="shipping_area"/>
            <result property="address" column="shipping_detailArea"/>
            <result property="tel" column="shipping_tel"/>
            <result property="receiver" column="shipping_receiver"/>
            <result property="isDefault" column="shipping_isDefault"/>
        </association>
    </resultMap>

    <!-- 分页查询订单 -->
    <select id="getOrderPage" resultMap="orderResultMap">
        SELECT
        o.tradeID,
        o.sellerID,
        o.buyerID,
        o.goodsID,
        g.price,
        g.deliveryMethod,
        o.orderTime,
        o.payTime,
        o.shippingTime,
        o.turnoverTime,
        o.shippingCost,
        o.status,
        us.userName AS sellerName,
        ub.userName AS buyerName,
        g.goodsName AS goodsName,

        -- 发货地址（senderAddress）
        a1.addrID AS sender_addrID,
        a1.userID AS sender_userID,
        a1.province AS sender_province,
        a1.city AS sender_city,
        a1.districts AS sender_area,
        a1.address AS sender_detailArea,
        a1.tel AS sender_tel,
        a1.receiver AS sender_receiver,
        a1.isDefault AS sender_isDefault,

        -- 收货地址（shippingAddress）
        a2.addrID AS shipping_addrID,
        a2.userID AS shipping_userID,
        a2.province AS shipping_province,
        a2.city AS shipping_city,
        a2.districts AS shipping_area,
        a2.address AS shipping_detailArea,
        a2.tel AS shipping_tel,
        a2.receiver AS shipping_receiver,
        a2.isDefault AS shipping_isDefault

        FROM trade_records o
        LEFT JOIN users us ON o.sellerID = us.userID
        LEFT JOIN users ub ON o.buyerID = ub.userID
        LEFT JOIN goods g ON o.goodsID = g.goodsID

        -- 正确的 JOIN 顺序
        LEFT JOIN address a1 ON o.deliveryAddrID = a1.addrID   <!-- 发货地址 -->
        LEFT JOIN address a2 ON o.shippingAddrID = a2.addrID   <!-- 收货地址 -->

        <where>
            <if test="searchQuery != null and searchQuery != ''">
                (
                o.tradeID = #{searchQuery}
                or us.userName LIKE CONCAT('%', #{searchQuery}, '%')
                OR ub.userName LIKE CONCAT('%', #{searchQuery}, '%')
                OR g.goodsName LIKE CONCAT('%', #{searchQuery}, '%')
                )
            </if>
        </where>

        ORDER BY o.orderTime DESC
    </select>

</mapper>
